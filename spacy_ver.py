import spacy
import gradio as gr

nlp = spacy.load("uk_core_news_sm")

def highlight_proper_nouns(text):
    doc = nlp(text)
    highlighted_text = text
    for ent in reversed(doc.ents):
        if ent.label_ in {"LOC", "ORG", "PER", "MISC", "GPE"}:
            highlighted_text = (
                highlighted_text[:ent.start_char]
                + f"<span style='color:blue; font-weight:bold;'>{ent.text}</span>"
                + highlighted_text[ent.end_char:]
            )
    return highlighted_text

def process_text(text):
    doc = nlp(text)
    proper_nouns = [
        f"{ent.text} ({ent.label_})"
        for ent in doc.ents
        if ent.label_ in {"LOC", "ORG", "PER", "MISC", "GPE"}
    ]
    proper_nouns_result = "\n".join(proper_nouns) if proper_nouns else "–í–ª–∞—Å–Ω—ñ –Ω–∞–∑–≤–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ."

    highlighted_text = highlight_proper_nouns(text)
    return (
        gr.update(value=f"–¢–µ–∫—Å—Ç —ñ–∑ –≤–ª–∞—Å–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏ –≤–∏–¥—ñ–ª–µ–Ω–∏–º–∏ <span style='color:blue; font-weight:bold;'> "
                        f"—Å–∏–Ω—ñ–º </span> –∫–æ–ª—å–æ—Ä–æ–º:", visible=True),
        gr.update(value=highlighted_text, visible=True),
        gr.update(value=proper_nouns_result, visible=True)
    )

description = """
### –û–ø–∏—Å –∑–Ω–∞—á–µ–Ω—å —Ç–∏–ø—ñ–≤ –≤–ª–∞—Å–Ω–∏—Ö –Ω–∞–∑–≤:

- **LOC (Location)**: –õ–æ–∫–∞—Ü—ñ—è –∞–±–æ –≥–µ–æ–≥—Ä–∞—Ñ—ñ—á–Ω–µ –º—ñ—Å—Ü–µ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º—ñ—Å—Ç–∞, —Å–µ–ª–∞, –≤—É–ª–∏—Ü—ñ.
- **ORG (Organization)**: –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è, –∫–æ–º–ø–∞–Ω—ñ—è –∞–±–æ —ñ–Ω—à—ñ –æ–±'—î–¥–Ω–∞–Ω–Ω—è, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ–º–ø–∞–Ω—ñ—ó, —à–∫–æ–ª–∏, –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó.
- **PER (Person)**: –ü–µ—Ä—Å–æ–Ω–∞–ª—ñ—è, –ª—é–¥–∏–Ω–∞, –∞–±–æ –Ω–∞–∑–≤–∞ –æ—Å–æ–±–∏.
- **GPE (Geopolitical Entity)**: –ì–µ–æ–ø–æ–ª—ñ—Ç–∏—á–Ω–∞ –æ–¥–∏–Ω–∏—Ü—è, —â–æ –≤–∫–ª—é—á–∞—î –∫—Ä–∞—ó–Ω–∏, –º—ñ—Å—Ç–∞, —Ä–µ–≥—ñ–æ–Ω–∏.
- **MISC (Miscellaneous)**: –Ü–Ω—à—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, —â–æ –Ω–µ –ø—ñ–¥–ø–∞–¥–∞—é—Ç—å –ø—ñ–¥ –∂–æ–¥–Ω—É –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö.
"""

instruction = """
1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –ø—Ä–æ–≥—Ä–∞–º—É —á–µ—Ä–µ–∑ –≤–µ–±-–±—Ä–∞—É–∑–µ—Ä
2. –ù–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ:
    2.1 	–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —É —Ç–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ;
    2.2 	–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏".
3. –û–∑–Ω–∞–π–æ–º—Ç–µ—Å—è –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:
    3.1 	–¢–µ–∫—Å—Ç —ñ–∑ –≤–∏–¥—ñ–ª–µ–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏ –∑‚Äô—è–≤–∏—Ç—å—Å—è —É —Å–∏–Ω—å–æ–º—É –∫–æ–ª—å–æ—Ä—ñ;
    3.2 	–°–ø–∏—Å–æ–∫ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –Ω–∞–∑–≤ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç—å—Å—è –æ–∫—Ä–µ–º–æ.
4. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –≤–∫–ª–∞–¥–∫—É "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ç–∏–ø–∏ –Ω–∞–∑–≤" –¥–ª—è –¥–æ–≤—ñ–¥–∫–∏ —â–æ–¥–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π.
- –£–í–ê–ì–ê!!! –ë—É–¥—å-—è–∫—ñ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç—ñ —É –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—ñ –≤–ª–∞—Å–Ω–∏—Ö –Ω–∞–∑–≤ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ –æ–±–º–µ–∂–µ–Ω–æ—é –∫—ñ–ª–∫—ñ—Å—Ç—é –¥–∞–Ω–∏—Ö, —â–æ –æ–±—Ä–æ–±–ª—è—î –º–æ–¥–µ–ª—å spaCy

"""
with gr.Blocks() as demo:
    with gr.Tab("–ì–æ–ª–æ–≤–Ω–∞"):
        with gr.Column():
            gr.Markdown("<h2>–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–∏—Ö –Ω–∞–∑–≤ —É —Ç–µ–∫—Å—Ç—ñ üîç</h2>")
            gr.Markdown(
                "–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –≤–ª–∞—Å–Ω–∏—Ö –Ω–∞–∑–≤ —ñ —Ç–µ–∫—Å—Ç —ñ–∑ –≤–∏–¥—ñ–ª–µ–Ω–∏–º–∏ –Ω–∞–∑–≤–∞–º–∏."
            )
        with gr.Row():
            with gr.Column(scale=1):
                input_text = gr.Textbox(
                    label="",
                    lines=10,
                    placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç—É—Ç..."
                )
                submit_button = gr.Button("–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏")
                gr.Markdown("""
                            <p style="font-size: 0.85em; color: gray;">
                                –ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è –≤–ª–∞—Å–Ω—ñ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ü—å, –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ–π, –ª—é–¥–µ–π, —Ç–æ—â–æ.
                            </p>
                            """)

            with gr.Column(scale=1):
                title_html = gr.Markdown(visible=False)
                result_html = gr.HTML(visible=False)
                result_textbox = gr.Textbox(label="–ó–Ω–∞–π–¥–µ–Ω—ñ –≤–ª–∞—Å–Ω—ñ –Ω–∞–∑–≤–∏: ", visible=False)

        examples = gr.Examples(
            examples=[
                ("–ü—ñ–¥ —á–∞—Å –≤—ñ–¥–≤—ñ–¥—É–≤–∞–Ω–Ω—è –†–∏–º—É, –º–∏ –≤–∏—Ä—ñ—à–∏–ª–∏ –ø—ñ–¥–Ω—è—Ç–∏—Å—è –Ω–∞ –≤–µ—Ä—à–∏–Ω—É –ö–æ–ª—ñ–∑–µ—é, —â–æ–± –ø–æ–º–∏–ª—É–≤–∞—Ç–∏—Å—è –ø–∞–Ω–æ—Ä–∞–º–æ—é "
                 "–§–æ—Ä—É–º—É –†–æ–º–∞–Ω—É, –∞ –ø–æ—Ç—ñ–º –≤—ñ–¥–≤—ñ–¥–∞—Ç–∏ –í–∞—Ç–∏–∫–∞–Ω—Å—å–∫—ñ –º—É–∑–µ—ó —Ç–∞ –ø–æ–±–∞—á–∏—Ç–∏ –°–∏–∫—Å—Ç–∏–Ω—Å—å–∫—É –∫–∞–ø–µ–ª—É."),
                ("–ù–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—ñ 'Atlas Weekend' –≥—É—Ä—Ç '–û–∫–µ–∞–Ω –ï–ª—å–∑–∏' –ø—Ä–µ–∑–µ–Ω—Ç—É–≤–∞–≤ –Ω–æ–≤—É –ø—ñ—Å–Ω—é, "
                 "–∞ —Å–ø—ñ–≤–∞—á–∫–∞ –î–∂–∞–º–∞–ª–∞ –≤–∏–∫–æ–Ω–∞–ª–∞ —Å–≤—ñ–π —Ö—ñ—Ç, —è–∫–∏–π –ø–µ—Ä–µ–º—ñ–≥ –Ω–∞ '–Ñ–≤—Ä–æ–±–∞—á–µ–Ω–Ω—ñ'."),
            ],
            inputs=input_text,
            label="–ü—Ä–∏–∫–ª–∞–¥–∏ —Ç–µ–∫—Å—Ç—É"
        )

    with gr.Tab("–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ç–∏–ø–∏ –Ω–∞–∑–≤"):
        gr.Markdown(description)

    with gr.Tab("–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –ø–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—é"):
        gr.Markdown(instruction)

    gr.HTML("""
    <hr>
    <p style="text-align: center; font-size: 0.85em; color: gray;">
    –†–æ–∑—Ä–æ–±–ª–µ–Ω–æ –∑–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤–æ—ó –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ–º–ø–∞–Ω—ñ—ó-–º–µ—Ü–µ–Ω–∞—Ç–∞ '—Ñ–∞–Ω-–∫–ª—É–± –ø–µ–Ω—ñ –∂–ª–æ–º–æ–¥—î–ª–∞' üíôüíõ
    </p>
    """)

    submit_button.click(
        process_text,
        inputs=input_text,
        outputs=[title_html, result_html, result_textbox],
    )

demo.launch()
